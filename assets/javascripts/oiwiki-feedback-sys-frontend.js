(function(_,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(_=typeof globalThis<"u"?globalThis:_||self,h(_.OIWikiFeedbackSysFrontend={}))})(this,function(_){"use strict";const h=function(t,e){return t.reduce((o,a)=>((o[e(a)]=o[e(a)]||[]).push(a),o),{})},V=new Intl.DateTimeFormat(void 0,{dateStyle:"short",timeStyle:"short"});let E=!1,L="/api",n=null,f,T,w;const q=({id:t,content:e,actions:o=new Map,parent:a=document.body,insertPosition:l="afterend",tag:m="div",initialize:i=()=>{}})=>{let d=document.querySelector(`#${t}`);if(d)return d;a.insertAdjacentHTML(l,`
    <${m} id="${t}">
      ${e.trim()}
    </${m}>
    `.trim()),d=document.querySelector(`#${t}`),i(d);const c=d.querySelectorAll("[data-action]");for(const C of c)C.addEventListener("click",y=>{var s;y.stopPropagation();const g=y.currentTarget,r=g.dataset.action??"";(s=o.get(r))==null||s(g)});return d},k=({el:t,focusReply:e=!1})=>{n!==t&&(n==null||n.classList.remove("review_selected"),n=t),((n==null?void 0:n.classList.contains("review_has_comments"))===!0||e)&&(n.classList.remove("review_focused"),n.classList.add("review_selected"),S())},P=()=>{n==null||n.classList.remove("review_selected"),n=null},z=({el:t})=>{q({id:"review-context-menu",content:`
    <button data-action="comment">
      <!-- <iconify-icon class="iconify-inline" icon="material-symbols:add-comment-outline-rounded"></iconify-icon> -->
      <svg class="iconify-icon iconify-inline" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 11v2q0 .425.288.713T12 14t.713-.288T13 13v-2h2q.425 0 .713-.288T16 10t-.288-.712T15 9h-2V7q0-.425-.288-.712T12 6t-.712.288T11 7v2H9q-.425 0-.712.288T8 10t.288.713T9 11zm-5 7l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"></path></svg>
      <span>评论该段</span>
    </button>
    `,parent:t,insertPosition:"beforeend",actions:new Map([["comment",e=>{e.remove(),k({el:t,focusReply:!0})}]]),initialize:e=>{e.addEventListener("mouseenter",()=>{t.classList.add("review_focused")}),e.addEventListener("mouseleave",()=>{t.classList.remove("review_focused")})}})},j=()=>{document.querySelector("#review-context-menu").remove()},S=async()=>{const t=[...await D()],e=n;e&&t.find(a=>a.offset.start===parseInt(e.dataset.originalDocumentStart)&&a.offset.end===parseInt(e.dataset.originalDocumentEnd))===void 0&&t.push({id:-1,offset:{start:parseInt(e.dataset.originalDocumentStart),end:parseInt(e.dataset.originalDocumentEnd)},commenter:{name:"新评论"},comment:"",created_time:new Date().toISOString()}),A(t);let o=document.querySelector(`#review-comments-panel .comments_group[data-original-document-start="${n==null?void 0:n.dataset.originalDocumentStart}"][data-original-document-end="${n==null?void 0:n.dataset.originalDocumentEnd}"]`);o==null||o.classList.add("review_selected"),o==null||o.scrollIntoView({behavior:"smooth",block:"start"}),T.classList.add("review_hidden"),w.classList.remove("review_hidden")},x=()=>{w.classList.add("review_hidden"),T.classList.remove("review_hidden")},R=async({offsets:t,username:e,content:o})=>{const a=sessionStorage.getItem("commitHash");if(!a)throw new Error("找不到 Commit hash，请联系站点管理员");const l={offset:{start:t[0],end:t[1]},commenter:{name:e},comment:o},m=await fetch(`${L}comment/${encodeURIComponent(new URL(window.location.href).pathname)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...l,commit_hash:a})});if(!m.ok)throw m;f&&f.push({...l,id:f.length,created_time:new Date().toISOString()}),I()},D=async()=>{if(f)return f;const t=await fetch(`${L}comment/${encodeURIComponent(new URL(window.location.href).pathname)}`);if(!t.ok)throw t;const e=(await t.json()).data;return f=e,e},A=t=>{var l;const e=w.querySelector(".panel_main"),o=document.createDocumentFragment(),a=h(t,m=>`${m.offset.start}-${m.offset.end}`);for(const m of Object.keys(a).sort((i,d)=>parseInt(i.split("-")[0])-parseInt(d.split("-")[0]))){const i=document.createElement("div");i.classList.add("comments_group");const d=m.split("-");i.dataset.originalDocumentStart=d[0],i.dataset.originalDocumentEnd=d[1];const c=document.querySelector(`.review_enabled[data-original-document-start="${i.dataset.originalDocumentStart}"][data-original-document-end="${i.dataset.originalDocumentEnd}"]`),C=(c==null?void 0:c.textContent)??"";i.innerHTML=`
      <div class="comments_group_header">
        <span class="comments_group_text_content">${C}</span>
      </div>
      <div class="comments_group_main"></div>
      <div class="comments_group_footer">
        <div class="comment_reply_panel">
          <input required placeholder="署名为..." maxlength="255"></input>
          <textarea required placeholder="写下你的评论..."  autocapitalize="sentences" autocomplete="on" spellcheck="true" autofocus="true" maxlength="65535"></textarea>
          <div class="comment_reply_actions">
            <span class="comment_reply_notification"></span>
            <button class="comment_reply_item" data-action="cancel">取消</button>
            <button class="comment_reply_item comment_reply_item_primary" data-action="submit">提交</button>
        </div>
      </div>
    `.trim(),i.querySelector(".comment_reply_panel textarea").addEventListener("input",r=>{const s=r.currentTarget;s.style.height="5px",s.style.height=s.scrollHeight+"px"}),(l=i.querySelector(".comment_reply_actions"))==null||l.addEventListener("click",r=>{if(!(r.target instanceof HTMLButtonElement))return;const s=r.target,M=i.querySelector(".comment_reply_panel input"),v=i.querySelector(".comment_reply_panel textarea"),u=i.querySelector(".comment_reply_notification"),b=i.querySelector(".comment_reply_item[data-action='submit']");switch(s==null?void 0:s.dataset.action){case"cancel":v.disabled=!1,v.value="",u.textContent="",b.disabled=!1;break;case"submit":if(v.disabled=!0,b.disabled=!0,!M.checkValidity()){u.textContent="请填写署名";return}if(!v.checkValidity()){u.textContent="请填写评论内容";return}u.textContent="",R({offsets:[parseInt(n.dataset.originalDocumentStart),parseInt(n.dataset.originalDocumentEnd)],username:M.value,content:v.value}).then(()=>{v.disabled=!1,v.value="",u.textContent="",b.disabled=!1,S()}).catch(async p=>{var H;if(console.error(p),p instanceof Error)u.textContent=p.message;else if(p instanceof Response)if(((H=p.headers.get("content-type"))==null?void 0:H.includes("application/json"))===!0){const F=await p.json();u.textContent=F.error}else u.textContent=`未知接口错误：${p.status}(${p.statusText})`;else u.textContent="提交失败，请稍后再试";v.disabled=!1,b.disabled=!1});break}}),i.addEventListener("mouseenter",()=>{c==null||c.classList.add("review_focused")}),i.addEventListener("mouseleave",()=>{c==null||c.classList.remove("review_focused")}),i.addEventListener("click",r=>{var s;r.stopPropagation(),n==null||n.classList.remove("review_selected"),c==null||c.classList.remove("review_focused"),c==null||c.classList.add("review_selected"),(s=document.querySelector(".comments_group.review_selected"))==null||s.classList.remove("review_selected"),i.classList.add("review_selected"),n=c,n==null||n.scrollIntoView({behavior:"smooth",block:"center"})});const y=a[m].sort((r,s)=>new Date(r.created_time).getTime()-new Date(s.created_time).getTime()),g=i.querySelector(".comments_group_main");for(const r of y){const s=document.createElement("div");s.classList.add("comment"),s.innerHTML=`
        <div class="comment_header">
          <span class="comment_commenter"></span>
          <span class="comment_time">${V.format(new Date(r.created_time))}</span>
        </div>
        <div class="comment_main"></div>
      `.trim(),s.querySelector(".comment_commenter").textContent=r.commenter.name,s.querySelector(".comment_main").textContent=r.comment,g.appendChild(s)}o.appendChild(i)}for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(o)},I=async()=>{const t=Array.from(document.querySelectorAll(".review_enabled[data-original-document-start][data-original-document-end]"));await D();for(let e of t)e.classList.remove("review_has_comments"),f.find(o=>o.offset.start===parseInt(e.dataset.originalDocumentStart)&&o.offset.end===parseInt(e.dataset.originalDocumentEnd))&&e.classList.add("review_has_comments")},$="0.2.0";function B(t,{apiEndpoint:e="/api"}={}){L=e.endsWith("/")?e:e+"/";const o=Array.from(t.querySelectorAll("[data-original-document-start][data-original-document-end]"));if(!o){console.warn("oiwiki-feedback-sys-frontend not found any offsets to inject, quitting...");return}for(let a of o)a.classList.add("review_enabled"),a.addEventListener("click",l=>{l.stopPropagation(),k({el:l.currentTarget})}),a.addEventListener("mouseenter",l=>{z({el:l.currentTarget})}),a.addEventListener("mouseleave",()=>{j()});if(f=void 0,I(),E){x(),console.log("oiwiki-feedback-sys-frontend has been successfully reset.");return}document.addEventListener("click",()=>{P()}),T=q({id:"review-comments-button",content:`
    <button data-action="open">
      <!-- <iconify-icon class="iconify-inline" icon="material-symbols:comment-outline-rounded"></iconify-icon> -->
      <svg class="iconify-icon iconify-inline" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M7 14h10q.425 0 .713-.288T18 13t-.288-.712T17 12H7q-.425 0-.712.288T6 13t.288.713T7 14m0-3h10q.425 0 .713-.288T18 10t-.288-.712T17 9H7q-.425 0-.712.288T6 10t.288.713T7 11m0-3h10q.425 0 .713-.288T18 7t-.288-.712T17 6H7q-.425 0-.712.288T6 7t.288.713T7 8M4 18q-.825 0-1.412-.587T2 16V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v15.575q0 .675-.612.938T20.3 20.3L18 18zm14.85-2L20 17.125V4H4v12zM4 16V4z"></path></svg>
    </button>
    `,actions:new Map([["open",()=>S()]])}),w=q({id:"review-comments-panel",content:`
    <div class="panel_header">
      <span>本页评论</span>
      <button data-action="close">
        <!-- <iconify-icon class="iconify-inline" icon="material-symbols:close"></iconify-icon> -->
        <svg class="iconify-icon iconify-inline" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z"></path></svg>
      </button>
    </div>
    <div class="panel_main"></div>
    `,insertPosition:"beforeend",actions:new Map([["close",()=>x()]])}),x(),console.log(`oiwiki-feedback-sys-frontend version ${$} has been successfully installed.`),E=!0}_.__VERSION__=$,_.setupReview=B,Object.defineProperty(_,Symbol.toStringTag,{value:"Module"})});
